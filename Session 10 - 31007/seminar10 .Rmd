---
title: "Seminar 10"
author: "Melanie Tran"
date: "12/11/2020"
output: html_document
---

```{r setup, include=FALSE}

dataPath <- setwd('/Users/meltra02/Desktop/MSCA/Quarter 1/31007 - Stats Analysis/Session 10 - 31007/')
data <- read.csv(paste(dataPath, "test_sample.csv", sep="/"))
```

```{r}
head(data)
```


```{r}
head(data[,-1])#fertility is the response variable
```

```{r}
dataPredictors<-data[,-1]
pairs(data)
```

```{r}
cor(data)
```
1.1 Linear model analysis using summary() and drop1()
```{r}
linMod<-lm(Y~.,data=data)
summary(linMod)
```
```{r}
drop1(linMod)
```

```{r}
library(dLagM)
```
```{r}
linMod$coefficients
```

```{r}

linModSorted <-(drop1(linMod))
sortScore(linModSorted, score = "aic")
```

```{r}
linMod_wDrop<-lm(Y~ X89+X183+X115+X3+X69+X108+X148+X154+X25+X152+X71+X49+X144+X63+X23+X6+X128+X138+X199+X44+X140+X104+X12+X161+X121+X129+X87+X173+X126+X17+X74+X172+X24+X100+X48+X181+X120+X164+X30+X91+X41+X157+X94+X7+X163+X197+X34+X127+X58+X162+X51+X86+X43+X53+X84+X125+X111+X105+X146+X35+X195+X165+X40+X39+X124+X200+X65+X80+X191+X175+X95+X1+X156+X151+X37 + X18+X196+X113+X77+X72+X64+X88+X101+X4+X38+X62+X75+X137+X149+X135+X136, data=data)
summary(linMod_wDrop)
```


```{r}
drop1(linMod_wDrop)
```
```{r}
n1 = 91
```



1.2 Relative Importance Measures
```{r}
suppressMessages(library(relaimpo))
```


```{r}
metrics <- calc.relimp(linMod, type = "last")
metrics
```

```{r}
slotNames(metrics)
```

```{r}
(metrics.rank<-metrics@lmg.rank)
```
```{r}
(totalRSq.lmg<-sum(metrics@lmg))
```

```{r}
sum(metrics@last)
```
Compare totalRSq.lmg with the summary of linear model linMod.
Compare the sum of metrics.swiss@first with the summary of linear model linMod and with the sum of squares of correlation coefficients of predictors and the output.

```{r}
sum(apply(data[,-1],2,cor,data[,1])^2)
```


1.3 Selection of predictors based on regsubsets()

```{r}
library(leaps)
```

```{r}
subsets<-regsubsets(x=data[2:200],y=data$Y)
summary(subsets)$which > 0.9
```

```{r}
summary(subsets)$rsq
```


1.4 Selection of predictors based on PCA
Run PCA on predictors.
```{r}
(swissPredictors.PCA<-princomp(swissPredictors))
```

Explore the PCA object swissPredictors.PCA.
Find relative importance of the factors.

```{r}
names(swissPredictors.PCA)
```
```{r}
plot(swissPredictors.PCA)
```



```{r}
swissPredictors.PCA$sdev^2

```


```{r}
barplot(swissPredictors.PCA$sdev^2/sum(swissPredictors.PCA$sdev^2),ylim=c(0,1))
```
```{r}
cumsum(swissPredictors.PCA$sdev^2/sum(swissPredictors.PCA$sdev^2))
```

Interpret factor loadings. 
```{r}
(swissPCALoadings<-swissPredictors.PCA$loadings)
```

```{r}
#Plot loadings
matplot(1:5,swissPredictors.PCA$loadings,type="l",lty=1,lwd=2,xaxt="n",xlab="Predictor",ylab="Factor Loadings",ylim=c(-1,1.5),col=c("black","red","blue","green","cyan"))
abline(h=0)
axis(1, 1:5,labels=colnames(swissPredictors))
legend("topright",legend=c("L1","L2","L3","L4","L5"),lty=1,lwd=2,cex=.7,col=c("black","red","blue","green","cyan"))
```

What is center? ( y means)
```{r}
swissPredictors.PCA$center
```

Create new data frame with principal components as predictors.
```{r}
swissPCAFactors<-swissPredictors.PCA$scores
swissRotated<-as.data.frame(cbind(Fertility=swiss$Fertility,swissPCAFactors))
head(swissRotated)
head(swiss)
```

Look at the factors (scores)

```{r}
#Plot
matplot(swissPredictors.PCA$scores,type="l",lty=1,lwd=2,ylim=c(-60,70),col=c("black","red","blue","green","cyan"))
legend("topright",legend=c("F1","F2","F3","F4","F5"),lty=1,lwd=2,col=c("black","red","blue","green","cyan"))


```
```{r}
#Pairs
pairs(as.matrix(swissRotated))
```

```{r}
#Correlation matrix
cor(swissPredictors.PCA$scores)
```

Look at the relationships of factors and the column Fertility.
```{r}
(rSqrCorrelations<-apply(swissPredictors.PCA$scores,2,cor,swiss$Fertility)^2)
```

```{r}
sum(rSqrCorrelations)
```
Fit linear model with the PCA factors as predictors.
```{r}
linModPCA<-lm(Fertility~.,data=swissRotated)
summary(linModPCA)
```
```{r}
summary(linMod)
```

Calculate relative importance measures for the PCA factors.
```{r}
metrics.swiss.pca <- calc.relimp(linModPCA, type = c("lmg", "first", "last","betasq", "pratt"))
metrics.swiss.pca
```

```{r}
metrics.swiss.pca@lmg.rank
```

```{r}
sum(metrics.swiss.pca@lmg)
```

Reorder the components from high importance to low importance and fit the sequence of linear models.
```{r}
orderComponents<-c(3,1,5,2,4)
swissRotatedReordered<-swissRotated[,c(1,orderComponents+1)]
(nestedRSquared<-sapply(2:6,function(z) summary(lm(Fertility~.,data=swissRotatedReordered[,1:z]))$r.squared))
```
```{r}
matplot(cbind(Regsubsets=summary(subsetsSwiss)$rsq,PCA=nestedRSquared),type="b",xlab="Number of Variables",ylab="R.Squared",lty=1,lwd=2,pch=16)
legend("bottomright",legend=c("Regsubsets","nestedRSquared"),lty=1,lwd=2,col=c("black","red"))
```
Check if regsubsets() gives a different solution in case of PCA factors as predictors.
```{r}
library(leaps)
subsetsSwissRotated<-regsubsets(x=swissPredictors.PCA$scores,y=swiss$Fertility)
summary(subsetsSwissRotated)$which
```

```{r}
summary(subsetsSwissRotated)$rsq
```
1.5 Restoring slopes for original predictors
```{r}
(PCA.rank<-metrics.swiss.pca@last.rank)
```

```{r}
orderedLoadings<-swissPCALoadings[,order(PCA.rank)]
orderedCoefficientsPCA<-linModPCA$coefficients[-1][order(PCA.rank)]

restoredCoefficients<-orderedLoadings%*%orderedCoefficientsPCA
cbind(restoredCoefficients,linMod$coefficients[-1])
```

